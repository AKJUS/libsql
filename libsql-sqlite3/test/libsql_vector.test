# 2024-07-04
#
# Copyright 2024 the libSQL authors
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of
# this software and associated documentation files (the "Software"), to deal in
# the Software without restriction, including without limitation the rights to
# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
# the Software, and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
# FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
# COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
# IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#
#***********************************************************************
# This file implements regression tests for libSQL library.  The
# focus of this file is vector search.


set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix vector

do_execsql_test vector-1-inserts {
  CREATE TABLE t1( xv FLOAT32(3) );
  INSERT INTO t1(rowid,xv) VALUES(1, vector('[1,2,3]'));
  INSERT INTO t1(rowid,xv) VALUES(2, vector('[2,3,4]'));
  INSERT INTO t1(rowid,xv) VALUES(3, vector('[5,6,7]'));
} {}

do_execsql_test vector-1-func-valid {
  SELECT vector_extract(vector('[]'));
  SELECT vector_extract(vector(x''));
  SELECT vector_extract(vector('  [  1  ,  2  ,  3  ]  '));
  SELECT vector_extract(vector('[-1000000000000000000]'));
  SELECT hex(vector('[1.10101010101010101010101010]'));
  SELECT hex(vector32('[1.10101010101010101010101010]'));
  SELECT hex(vector64('[1.10101010101010101010101010]'));
  SELECT vector_extract(x'E6ED8C3F');
  SELECT vector_extract(x'F37686C4BC9DF13F02');
  SELECT vector_extract(vector(x'F37686C4BC9DF13F01'));
  SELECT vector_distance_cos('[1,1]', '[1,1]');
  SELECT vector_distance_cos('[1,1]', '[-1,-1]');
  SELECT vector_distance_cos('[1,1]', '[-1,1]');
  SELECT vector_distance_cos('[1,2]', '[2,1]');
  SELECT vector_distance_cos(vector1bit('[10,-10]'), vector1bit('[-5,4]'));
  SELECT vector_distance_cos(vector1bit('[10,-10]'), vector1bit('[20,4]'));
  SELECT vector_distance_cos(vector1bit('[10,-10]'), vector1bit('[20,-2]'));

  SELECT vector_distance_cos(vector8('[10,-10]'), vector8('[10,-10]'));
  SELECT vector_distance_cos(vector32('[10,-10]'), vector32('[10,-10]'));

  SELECT vector_distance_cos(vector8('[-21,-31,0,2,2.1,2.2,105]'), vector8('[-20,-30,0,1,1.1,1.2,100]'));
  SELECT vector_distance_cos(vector32('[-21,-31,0,2,2.1,2.2,105]'), vector32('[-20,-30,0,1,1.1,1.2,100]'));

  SELECT vector_distance_cos(vector8('[-20,-30,0,1,1.1,1.2,100]'), vector8('[-20,-30,0,1,1.1,1.2,10000]'));
  SELECT vector_distance_cos(vector32('[-20,-30,0,1,1.1,1.2,100]'), vector32('[-20,-30,0,1,1.1,1.2,10000]'));
} {
  {[]} 
  {[]} 
  {[1,2,3]} 
  {[-1e+18]} 
  {E6ED8C3F} 
  {E6ED8C3F} 
  {F37686C4BC9DF13F02} 
  {[1.10101]} 
  {[1.10101]} 
  {[-1075.72,1.88763]}
  {0.0} 
  {2.0} 
  {1.0} 
  {0.200000002980232}
  {2.0}
  {1.0}
  {0.0}

  {-6.10352568486405e-09} {0.0}
  {0.000111237335659098} {0.000117244853754528}
  {0.0576796568930149} {0.0582110174000263}
}

do_execsql_test vector-1-conversion {
  SELECT hex(vector32('[]'));
  SELECT hex(vector64(vector32('[]')));

  SELECT vector_extract(vector32(vector1bit('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector32(vector1bit('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));
  SELECT vector_extract(vector32(vector32('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector32(vector32('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));
  SELECT vector_extract(vector32(vector64('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector32(vector64('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));

  SELECT vector_extract(vector64(vector1bit('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector64(vector1bit('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));
  SELECT vector_extract(vector64(vector32('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector64(vector32('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));
  SELECT vector_extract(vector64(vector64('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector64(vector64('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));

  SELECT vector_extract(vector1bit(vector1bit('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector1bit(vector1bit('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));
  SELECT vector_extract(vector1bit(vector32('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector1bit(vector32('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));
  SELECT vector_extract(vector1bit(vector64('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]'))), hex(vector1bit(vector64('[-0.000001,1e-100,1e100,-1e10,1e-10,0,1.5]')));

  SELECT vector_extract(vector8(vector1bit('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector8(vector1bit('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));
  SELECT vector_extract(vector8(vector32('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector8(vector32('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));
  SELECT vector_extract(vector8(vector64('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector8(vector64('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));
  SELECT vector_extract(vector8(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector8(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));

  SELECT vector_extract(vector1bit(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector1bit(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));
  SELECT vector_extract(vector32(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector32(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));
  SELECT vector_extract(vector64(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]'))), hex(vector64(vector8('[-20,-35.44,1,1.5,2,3,10,100,105,110]')));
} {
  {}
  02

  {[-1,-1,1,-1,1,-1,1]} 000080BF000080BF0000803F000080BF0000803F000080BF0000803F
  {[-1e-06,0,Inf,-1e+10,1e-10,0,1.5]} BD3786B5000000000000807FF90215D0FFE6DB2E000000000000C03F
  {[-1e-06,0,Inf,-1e+10,1e-10,0,1.5]} BD3786B5000000000000807FF90215D0FFE6DB2E000000000000C03F

  {[-1,-1,1,-1,1,-1,1]} 000000000000F0BF000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F02
  {[-1e-06,0,Inf,-1e+10,1e-10,0,1.5]} 000000A0F7C6B0BE0000000000000000000000000000F07F000000205FA002C2000000E0DF7CDB3D0000000000000000000000000000F83F02
  {[-1e-06,1e-100,1e+100,-1e+10,1e-10,0,1.5]} 8DEDB5A0F7C6B0BE30058EE42EFF2B2B7DC39425AD49B254000000205FA002C2BBBDD7D9DF7CDB3D0000000000000000000000000000F83F02

  {[-1,-1,1,-1,1,-1,1]} 540903
  {[-1,-1,1,-1,1,-1,1]} 540903
  {[-1,1,1,-1,1,-1,1]} 560903

  {[-1,-1,1,1,1,1,1,1,1,1]} 0000FFFFFFFFFFFFFFFF00008180003C000080BF000204
  {[-20.0405,-35.44,1.06259,1.63295,2.2033,2.77365,10.1882,99.7337,104.867,110]} 1B004041424350EDF6FF0000A702123F8FC20DC2000204
  {[-20.0405,-35.44,1.06259,1.63295,2.2033,2.77365,10.1882,99.7337,104.867,110]} 1B004041424350EDF6FF0000A702123F8FC20DC2000204
  {[-20.0405,-35.44,1.06259,1.63295,2.2033,2.77365,10.1882,99.7337,104.867,110]} 1B004041424350EDF6FF0000A702123F8FC20DC2000204

  {[-1,-1,1,1,1,1,1,1,1,1]} FC03001603
  {[-20.0405,-35.44,1.06259,1.63295,2.2033,2.77365,10.1882,99.7337,104.867,110]} E152A0C18FC20DC20003883F6004D13FD0020D408083314008032341A277C742D0BBD1420000DC42
  {[-20.0405,-35.44,1.06259,1.63295,2.2033,2.77365,10.1882,99.7337,104.867,110]} 000000205C0A34C0000000E051B841C0000000006000F13F000000008C20FA3F000000005AA001400000000070300640000000006160244000000040F4EE5840000000007A375A400000000000805B4002
}

proc error_messages {sql} {
  set ret ""
  set stmt [sqlite3_prepare db $sql -1 dummy]
  sqlite3_step $stmt
  sqlite3_finalize $stmt
  set ret [sqlite3_errmsg db]
}

do_test vector-1-func-errors {
  set ret [list]
  lappend ret [error_messages {SELECT vector(1.2)}]
  lappend ret [error_messages {SELECT vector(10)}]
  lappend ret [error_messages {SELECT vector(NULL)}]
  lappend ret [error_messages {SELECT vector('')}]
  lappend ret [error_messages {SELECT vector('test')}]
  lappend ret [error_messages {SELECT vector('[1]]')}]
  lappend ret [error_messages {SELECT vector('[[1]')}]
  lappend ret [error_messages {SELECT vector('[1, 2, 1.1.1, 4]')}]
  lappend ret [error_messages {SELECT vector('[1.2')}]
  lappend ret [error_messages {SELECT vector(x'0000000000')}]
  lappend ret [error_messages {SELECT vector_distance_cos('[1,2,3]', '[1,2]')}]
  lappend ret [error_messages {SELECT vector_distance_cos(vector32('[1,2,3]'), vector64('[1,2,3]'))}]
} [list {*}{
  {vector: unexpected value type: got FLOAT, expected TEXT or BLOB}
  {vector: unexpected value type: got INTEGER, expected TEXT or BLOB}
  {vector: unexpected value type: got NULL, expected TEXT or BLOB}
  {vector: must start with '['}
  {vector: must start with '['}
  {vector: non-space symbols after closing ']' are forbidden}
  {vector: invalid float at position 0: '[1'}
  {vector: invalid float at position 2: '1.1.1'}
  {vector: must end with ']'}
  {vector: unexpected binary type: 0}
  {vector_distance_cos: vectors must have the same length: 3 != 2}
  {vector_distance_cos: vectors must have the same type: 1 != 2}
}]
